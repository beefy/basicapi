name: Deploy Indicator Cron Job

on:
  # Automatically deploy when changes are made to the main branch
  push:
    branches: [main]
    paths:
      - 'cron_jobs/**'
      - 'app/core/indicators.py'
      - 'app/core/cache.py'
      - 'Dockerfile.cron'
      - '.github/workflows/deploy-cron.yml'
  
  # Allow manual deployment
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: us-central1
  CRON_SERVICE: basicapi-indicator-cron
  REGION: us-central1

jobs:
  deploy-cron:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
    
    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev
    
    - name: Build and push cron job Docker image
      run: |
        # Build with the cron-specific Dockerfile
        docker build -f Dockerfile.cron -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.CRON_SERVICE }}/${{ env.CRON_SERVICE }}:${{ github.sha }} .
        docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.CRON_SERVICE }}/${{ env.CRON_SERVICE }}:${{ github.sha }}
    
    - name: Deploy cron job to Cloud Run
      id: deploy-cron
      uses: google-github-actions/deploy-cloudrun@v1
      with:
        service: ${{ env.CRON_SERVICE }}
        region: ${{ env.REGION }}
        image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.CRON_SERVICE }}/${{ env.CRON_SERVICE }}:${{ github.sha }}
        timeout: 900  # 15 minutes timeout for indicator calculation
        env_vars: |
          MONGODB_URL=${{ secrets.MONGODB_URL }}
          DATABASE_NAME=${{ secrets.DATABASE_NAME }}
          BIRDEYE_API_KEY=${{ secrets.BIRDEYE_API_KEY }}
        flags: |
          --no-traffic
          --port=8080
          --memory=2Gi
          --cpu=2
          --max-instances=1
          --min-instances=0
          --timeout=900
          --execution-environment=gen2
    
    - name: Create or update Cloud Scheduler job
      run: |
        # Check if scheduler job exists
        if gcloud scheduler jobs describe indicator-refresh-job --location=${{ env.REGION }} > /dev/null 2>&1; then
          echo "Updating existing scheduler job..."
          gcloud scheduler jobs update http indicator-refresh-job \
            --location=${{ env.REGION }} \
            --schedule="0 * * * *" \
            --time-zone="UTC" \
            --uri="${{ steps.deploy-cron.outputs.url }}" \
            --http-method=POST \
            --oidc-service-account-email="${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}" \
            --oidc-token-audience="${{ steps.deploy-cron.outputs.url }}" \
            --max-retry-attempts=3 \
            --max-retry-duration=600s \
            --min-backoff-duration=5s \
            --max-backoff-duration=300s
        else
          echo "Creating new scheduler job..."
          gcloud scheduler jobs create http indicator-refresh-job \
            --location=${{ env.REGION }} \
            --schedule="0 * * * *" \
            --time-zone="UTC" \
            --uri="${{ steps.deploy-cron.outputs.url }}" \
            --http-method=POST \
            --oidc-service-account-email="${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}" \
            --oidc-token-audience="${{ steps.deploy-cron.outputs.url }}" \
            --max-retry-attempts=3 \
            --max-retry-duration=600s \
            --min-backoff-duration=5s \
            --max-backoff-duration=300s \
            --description="Hourly refresh of cryptocurrency technical indicators"
        fi
    
    - name: Show deployment info
      run: |
        echo "Cron job service URL: ${{ steps.deploy-cron.outputs.url }}"
        echo "Scheduler job will run every hour at minute 0"
        echo "Next few run times (UTC):"
        python3 -c "
        from datetime import datetime, timedelta
        now = datetime.utcnow()
        next_hour = now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1)
        for i in range(5):
            run_time = next_hour + timedelta(hours=i)
            print(f'  {run_time.strftime(\"%Y-%m-%d %H:%M:%S UTC\")}')
        "