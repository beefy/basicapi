#!/usr/bin/env python3\n\"\"\"\nDatabase migration management script for BasicAPI\n\nUsage:\n    python migrate.py create <migration_name>  # Create a new migration\n    python migrate.py up                       # Run all pending migrations\n    python migrate.py down                     # Rollback last migration\n    python migrate.py status                   # Show migration status\n\"\"\"\n\nimport os\nimport sys\nfrom datetime import datetime\nfrom pymongo_migrate.migrate import Migrate\nfrom pymongo_migrate.config import Configuration\nfrom pymongo import MongoClient\n\n# Add the app directory to path for imports\nsys.path.append(os.path.join(os.path.dirname(__file__), 'app'))\n\nfrom app.core.config import settings\n\n\ndef create_migration(name: str):\n    \"\"\"Create a new migration file\"\"\"\n    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n    filename = f\"{timestamp}_{name}.py\"\n    filepath = os.path.join('migrations', filename)\n    \n    template = f'''\"\"\"Migration: {name}\n\nCreated: {datetime.now().isoformat()}\n\"\"\"\n\nfrom pymongo_migrate.actions import CreateIndex, DropIndex, CreateCollection, DropCollection\n\n\ndef upgrade(db):\n    \"\"\"Apply migration changes\"\"\"\n    # Add your upgrade logic here\n    pass\n\n\ndef downgrade(db):\n    \"\"\"Rollback migration changes\"\"\"\n    # Add your downgrade logic here\n    pass\n'''\n    \n    os.makedirs('migrations', exist_ok=True)\n    with open(filepath, 'w') as f:\n        f.write(template)\n    \n    print(f\"Created migration: {filepath}\")\n\n\ndef run_migrations():\n    \"\"\"Run all pending migrations\"\"\"\n    config = Configuration()\n    config.host = settings.mongodb_url.replace('mongodb://', '').split('/')[0].split(':')[0]\n    config.port = int(settings.mongodb_url.replace('mongodb://', '').split('/')[0].split(':')[1]) if ':' in settings.mongodb_url.replace('mongodb://', '').split('/')[0] else 27017\n    config.database = settings.database_name\n    config.migrations_dir = 'migrations'\n    \n    migrate = Migrate(config)\n    migrate.run()\n    print(\"Migrations completed\")\n\n\ndef rollback_migration():\n    \"\"\"Rollback the last migration\"\"\"\n    config = Configuration()\n    config.host = settings.mongodb_url.replace('mongodb://', '').split('/')[0].split(':')[0]\n    config.port = int(settings.mongodb_url.replace('mongodb://', '').split('/')[0].split(':')[1]) if ':' in settings.mongodb_url.replace('mongodb://', '').split('/')[0] else 27017\n    config.database = settings.database_name\n    config.migrations_dir = 'migrations'\n    \n    migrate = Migrate(config)\n    migrate.rollback()\n    print(\"Rollback completed\")\n\n\ndef migration_status():\n    \"\"\"Show migration status\"\"\"\n    config = Configuration()\n    config.host = settings.mongodb_url.replace('mongodb://', '').split('/')[0].split(':')[0]\n    config.port = int(settings.mongodb_url.replace('mongodb://', '').split('/')[0].split(':')[1]) if ':' in settings.mongodb_url.replace('mongodb://', '').split('/')[0] else 27017\n    config.database = settings.database_name\n    config.migrations_dir = 'migrations'\n    \n    migrate = Migrate(config)\n    status = migrate.status()\n    \n    print(\"Migration Status:\")\n    for migration in status:\n        print(f\"  {migration}\")\n\n\nif __name__ == \"__main__\":\n    if len(sys.argv) < 2:\n        print(__doc__)\n        sys.exit(1)\n    \n    command = sys.argv[1]\n    \n    if command == \"create\":\n        if len(sys.argv) < 3:\n            print(\"Usage: python migrate.py create <migration_name>\")\n            sys.exit(1)\n        create_migration(sys.argv[2])\n    elif command == \"up\":\n        run_migrations()\n    elif command == \"down\":\n        rollback_migration()\n    elif command == \"status\":\n        migration_status()\n    else:\n        print(f\"Unknown command: {command}\")\n        print(__doc__)\n        sys.exit(1)\n